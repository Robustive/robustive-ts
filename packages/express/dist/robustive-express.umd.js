(function(g,f){typeof exports=="object"&&typeof module!="undefined"?f(exports):typeof define=="function"&&define.amd?define(["exports"],f):(g=typeof globalThis!="undefined"?globalThis:g||self,f(g.RobustiveExpress={}))})(this,function(g){"use strict";class f{constructor(e=null){this.user=e}}class C extends f{}const E=i=>i.constructor===C,m=class{constructor(){return new Proxy(this,{get(e,t,s){return typeof t=="string"&&!(t in e)?t:Reflect.get(e,t,s)}})}},w=class{constructor(e){return new Proxy(this,{get(t,s,n){return typeof s=="string"&&!(s in t)?r=>Object.freeze(Object.assign(r||{},{scene:s,course:e})):Reflect.get(t,s,n)}})}},_=class{constructor(){return new Proxy(this,{get(e,t,s){return typeof t=="string"&&!(t in e)?t:Reflect.get(e,t,s)}})}};class v{constructor(e,t,s){this.domain=e,this.usecase=t,this.id=s,this.keys={basics:new m,alternatives:new m,goals:new m},this.basics=new w("basics"),this.alternatives=new w("alternatives"),this.goals=new w("goals")}next(e,t){return this.delegate!==void 0&&this.delegate.next!==void 0?this.delegate.next(e,t,this):Promise.reject(new Error)}just(e){return Promise.resolve(e)}authorize(e,t,s){if(this.delegate!==void 0&&this.delegate.authorize!==void 0)return this.delegate.authorize(e,t,s);throw new Error(`USECASE "${s}" IS NOT AUTHORIZED FOR ACTOR "${e.constructor.name}."`)}complete(e){this.delegate!==void 0&&this.delegate.complete!==void 0&&this.delegate.complete(e)}}const U={success:"success",failure:"failure"},O=class{constructor(){return new Proxy(this,{get(e,t,s){return typeof t=="string"&&!(t in e)?n=>Object.freeze(Object.assign(n,{type:t})):Reflect.get(e,t,s)}})}},P=i=>{const e="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";return Array.from(crypto.getRandomValues(new Uint8Array(i))).map(t=>e[t%e.length]).join("")},x=new WeakMap;class j{constructor(e,t,s,n,r){this.id=e,this._domain=t,this._usecase=s,this._scenario=r,x.set(this,n)}get currentContext(){return x.get(this)}set currentContext(e){x.set(this,e)}set(e){this._scenario.delegate=e}progress(e){if(this._scenario.authorize&&!this._scenario.authorize(e,this._domain,this._usecase)){const t=new b(e,this._domain,this._usecase);return Promise.reject(t)}return this._scenario.next(this.currentContext,e).then(t=>(this.currentContext=t,t))}interactedBy(e){const t=new Date,s=new O,n=c=>{const u=c.slice(-1)[0];return u.course==="goals"?Promise.resolve(c):this._scenario.next(u,e).then(l=>(this.currentContext=l,c.push(l),n(c)))};if(this._scenario.authorize&&!this._scenario.authorize(e,this._domain,this._usecase)){const c=new b(e,this._domain,this._usecase);return Promise.reject(c)}const r=[this.currentContext];return n(r).then(c=>{const u=new Date,l=u.getTime()-t.getTime(),a=c.slice(-1)[0],o=s.success({id:this.id,actor:e,domain:this._domain,usecase:this._usecase,startAt:t,endAt:u,elapsedTimeMs:l,performedScenario:c,lastSceneContext:a});return this._scenario.complete&&this._scenario.complete(o),o}).catch(c=>{console.error(c);const u=new Date,l=u.getTime()-t.getTime(),a=r.slice(-1)[0],o=s.failure({id:this.id,actor:e,domain:this._domain,usecase:this._usecase,startAt:t,endAt:u,elapsedTimeMs:l,performedScenario:r,failedSceneContext:a,error:c});return this._scenario.complete&&this._scenario.complete(o),o})}}const R=class{constructor(e,t,s,n){return new Proxy(this,{get(r,c,u){return typeof c=="string"&&!(c in r)?(l,a)=>{const o=Object.assign(l||{},{scene:c,course:s}),h=a||P(8),d=new n(e,t,h),y=new j(h,e,t,o,d);return Object.freeze(Object.assign(y,{domain:e,name:t,scene:c,course:s}))}:Reflect.get(r,c,u)}})}};class A{constructor(e,t,s){this.keys={basics:new _,alternatives:new _,goals:new _},this.basics=new R(e,t,"basics",s),this.alternatives=new R(e,t,"alternatives",s),this.goals=new R(e,t,"goals",s)}}const z=class{constructor(e,t){const s=Object.keys(t);return this.keys=s.reduce((n,r)=>(n[r]=r,n),{}),new Proxy(this,{get(n,r,c){return typeof r=="string"&&s.includes(r)?new A(e,r,t[r]):Reflect.get(n,r,c)}})}},D=class{constructor(e){const t=Object.keys(e);return this.keys=t.reduce((s,n)=>(s[n]=n,s),{}),new Proxy(this,{get(s,n,r){return typeof n=="string"&&t.includes(n)?new z(n,e[n]):Reflect.get(s,n,r)}})}};class b extends Error{constructor(e,t,s){super(`The actor "${e.constructor.name}" is not authorized to interact on usecase "${String(s)}" of domain "${String(t)}".`)}}const F=class{constructor(){return new Proxy(this,{get(e,t,s){return typeof t=="string"&&!(t in e)?t:Reflect.get(e,t,s)}})}},I=class{constructor(e){return this.keys=new F,new Proxy(this,{get(t,s,n){return typeof s=="string"&&!(s in t)?r=>Object.freeze(e!==void 0?Object.assign(new e,Object.assign(r||{},{case:s})):Object.assign(r||{},{case:s})):Reflect.get(t,s,n)}})}},T=new I;v.prototype.proceedUntilResponse=function(i,e,t,s){return this.delegate!==void 0&&this.delegate.proceedUntilResponse!==void 0?this.delegate.proceedUntilResponse(i,e,t,s,this):Promise.reject(new Error)},v.prototype.respond=function(i,e=T.normal({statusCode:200})){return Promise.resolve({...i,status:e})};const S={success:"success",failure:"failure"};j.prototype.handleRequest=function(i,e,t,s){const n=this,r=new Date,c=(a,o,h)=>{const d=h.slice(-1)[0];return d.course==="goals"||d.status?Promise.resolve(h):n._scenario.proceedUntilResponse(a,o,d,t).then(y=>(n.currentContext=y,h.push(y),c(a,o,h)))};if(n._scenario.authorize&&!n._scenario.authorize(t,n._domain,n._usecase)){const a=new b(t,n._domain,n._usecase);return Promise.reject(a)}const u=[n.currentContext],l=()=>c(i,e,u).then(a=>{const o=new Date,h=o.getTime()-r.getTime(),d=a.slice(-1)[0];return{type:S.success,id:n.id,actor:t,domain:n._domain,usecase:n._usecase,startAt:r,endAt:o,elapsedTimeMs:h,performedScenario:a,lastSceneContext:d}}).catch(a=>{const o=new Date,h=o.getTime()-r.getTime(),d=u.slice(-1)[0];return{type:S.failure,id:n.id,actor:t,domain:n._domain,usecase:n._usecase,startAt:r,endAt:o,elapsedTimeMs:h,performedScenario:u,failedSceneContext:d,error:a}});return s?s(l):l()},g.HandleResultType=S,g.ResponseStatus=T,Object.defineProperties(g,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}})});
//# sourceMappingURL=robustive-express.umd.js.map
