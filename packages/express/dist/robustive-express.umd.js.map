{"version":3,"file":"robustive-express.umd.js","sources":["../../core/dist/robustive.es.js","../src/index.ts"],"sourcesContent":["class AbstractActor {\n  constructor(user = null) {\n    this.user = user;\n  }\n}\nclass Nobody extends AbstractActor {\n}\nconst isNobody = (actor) => actor.constructor === Nobody;\nconst SceneFactory = class SceneFactory2 {\n  constructor() {\n    return new Proxy(this, {\n      get(target, prop, receiver) {\n        return typeof prop === \"string\" && !(prop in target) ? prop : Reflect.get(target, prop, receiver);\n      }\n    });\n  }\n};\nconst ContextFactory = class ContextFactory2 {\n  constructor(course) {\n    return new Proxy(this, {\n      get(target, prop, receiver) {\n        return typeof prop === \"string\" && !(prop in target) ? (withValues) => {\n          return Object.freeze(Object.assign(withValues || {}, { \"scene\": prop, course }));\n        } : Reflect.get(target, prop, receiver);\n      }\n    });\n  }\n};\nconst SceneFactoryAdapter = class SceneFactoryAdapter2 {\n  constructor() {\n    return new Proxy(this, {\n      get(target, prop, receiver) {\n        return typeof prop === \"string\" && !(prop in target) ? prop : Reflect.get(target, prop, receiver);\n      }\n    });\n  }\n};\nclass Scenario {\n  constructor(domain, usecase, id) {\n    this.domain = domain;\n    this.usecase = usecase;\n    this.id = id;\n    this.keys = {\n      basics: new SceneFactory(),\n      alternatives: new SceneFactory(),\n      goals: new SceneFactory()\n    };\n    this.basics = new ContextFactory(\"basics\");\n    this.alternatives = new ContextFactory(\"alternatives\");\n    this.goals = new ContextFactory(\"goals\");\n  }\n  next(to, actor) {\n    if (this.delegate !== void 0 && this.delegate.next !== void 0) {\n      return this.delegate.next(to, actor, this);\n    }\n    return Promise.reject(new Error());\n  }\n  just(next) {\n    return Promise.resolve(next);\n  }\n  authorize(actor, domain, usecase) {\n    if (this.delegate !== void 0 && this.delegate.authorize !== void 0) {\n      return this.delegate.authorize(actor, domain, usecase);\n    }\n    throw new Error(`USECASE \"${usecase}\" IS NOT AUTHORIZED FOR ACTOR \"${actor.constructor.name}.\"`);\n  }\n  complete(withResult) {\n    if (this.delegate !== void 0 && this.delegate.complete !== void 0) {\n      this.delegate.complete(withResult);\n    }\n  }\n}\nconst InteractResultType = {\n  success: \"success\",\n  failure: \"failure\"\n};\nconst InteractResultFactory = class InteractResultFactory2 {\n  constructor() {\n    return new Proxy(this, {\n      get(target, prop, receiver) {\n        return typeof prop === \"string\" && !(prop in target) ? (withValues) => {\n          return Object.freeze(Object.assign(withValues, { \"type\": prop }));\n        } : Reflect.get(target, prop, receiver);\n      }\n    });\n  }\n};\nconst generateId = (length) => {\n  const S = \"abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789\";\n  return Array.from(crypto.getRandomValues(new Uint8Array(length))).map((n) => S[n % S.length]).join(\"\");\n};\nconst currentContextStore = /* @__PURE__ */ new WeakMap();\nclass UsecaseImple {\n  constructor(id, domain, usecase, initialContext, scenario) {\n    this.id = id;\n    this._domain = domain;\n    this._usecase = usecase;\n    this._scenario = scenario;\n    currentContextStore.set(this, initialContext);\n  }\n  get currentContext() {\n    return currentContextStore.get(this);\n  }\n  set currentContext(context) {\n    currentContextStore.set(this, context);\n  }\n  set(delegate) {\n    this._scenario.delegate = delegate;\n  }\n  progress(actor) {\n    if (this._scenario.authorize && !this._scenario.authorize(actor, this._domain, this._usecase)) {\n      const err = new ActorNotAuthorizedToInteractIn(actor, this._domain, this._usecase);\n      return Promise.reject(err);\n    }\n    return this._scenario.next(this.currentContext, actor).then((nextScene) => {\n      this.currentContext = nextScene;\n      return nextScene;\n    });\n  }\n  interactedBy(actor) {\n    const startAt = new Date();\n    const InteractResult = new InteractResultFactory();\n    const recursive = (scenario2) => {\n      const lastScene = scenario2.slice(-1)[0];\n      if (lastScene.course === \"goals\") {\n        return Promise.resolve(scenario2);\n      }\n      return this._scenario.next(lastScene, actor).then((nextScene) => {\n        this.currentContext = nextScene;\n        scenario2.push(nextScene);\n        return recursive(scenario2);\n      });\n    };\n    if (this._scenario.authorize && !this._scenario.authorize(actor, this._domain, this._usecase)) {\n      const err = new ActorNotAuthorizedToInteractIn(actor, this._domain, this._usecase);\n      return Promise.reject(err);\n    }\n    const scenario = [this.currentContext];\n    return recursive(scenario).then((performedScenario) => {\n      const endAt = new Date();\n      const elapsedTimeMs = endAt.getTime() - startAt.getTime();\n      const lastSceneContext = performedScenario.slice(-1)[0];\n      const result = InteractResult.success({\n        id: this.id,\n        actor,\n        domain: this._domain,\n        usecase: this._usecase,\n        startAt,\n        endAt,\n        elapsedTimeMs,\n        performedScenario,\n        lastSceneContext\n      });\n      if (this._scenario.complete) {\n        this._scenario.complete(result);\n      }\n      return result;\n    }).catch((error) => {\n      console.error(error);\n      const endAt = new Date();\n      const elapsedTimeMs = endAt.getTime() - startAt.getTime();\n      const lastSceneContext = scenario.slice(-1)[0];\n      const result = InteractResult.failure({\n        id: this.id,\n        actor,\n        domain: this._domain,\n        usecase: this._usecase,\n        startAt,\n        endAt,\n        elapsedTimeMs,\n        performedScenario: scenario,\n        failedSceneContext: lastSceneContext,\n        error\n      });\n      if (this._scenario.complete) {\n        this._scenario.complete(result);\n      }\n      return result;\n    });\n  }\n}\nconst ScenarioFactory = class ScenarioFactory2 {\n  constructor(domain, usecase, course, scenario) {\n    return new Proxy(this, {\n      get(target, prop, receiver) {\n        return typeof prop === \"string\" && !(prop in target) ? (withValues, id) => {\n          const context = Object.assign(withValues || {}, { \"scene\": prop, course });\n          const _id = id || generateId(8);\n          const s = new scenario(domain, usecase, _id);\n          const usecaseImple = new UsecaseImple(_id, domain, usecase, context, s);\n          return Object.freeze(Object.assign(usecaseImple, { \"domain\": domain, \"name\": usecase, \"scene\": prop, course }));\n        } : Reflect.get(target, prop, receiver);\n      }\n    });\n  }\n};\nclass CourseSelector {\n  constructor(domain, usecase, scenario) {\n    this.keys = {\n      basics: new SceneFactoryAdapter(),\n      alternatives: new SceneFactoryAdapter(),\n      goals: new SceneFactoryAdapter()\n    };\n    this.basics = new ScenarioFactory(domain, usecase, \"basics\", scenario);\n    this.alternatives = new ScenarioFactory(domain, usecase, \"alternatives\", scenario);\n    this.goals = new ScenarioFactory(domain, usecase, \"goals\", scenario);\n  }\n}\nconst UsecaseSelector = class UsecaseSelector2 {\n  constructor(domain, scenarioConstructors) {\n    const usecaseKeys = Object.keys(scenarioConstructors);\n    this.keys = usecaseKeys.reduce((keys, usecase) => {\n      keys[usecase] = usecase;\n      return keys;\n    }, {});\n    return new Proxy(this, {\n      get(target, prop, receiver) {\n        return typeof prop === \"string\" && usecaseKeys.includes(prop) ? new CourseSelector(domain, prop, scenarioConstructors[prop]) : Reflect.get(target, prop, receiver);\n      }\n    });\n  }\n};\nconst Robustive = class Robustive2 {\n  constructor(requirements) {\n    const domainKeys = Object.keys(requirements);\n    this.keys = domainKeys.reduce((keys, domain) => {\n      keys[domain] = domain;\n      return keys;\n    }, {});\n    return new Proxy(this, {\n      get(target, prop, receiver) {\n        return typeof prop === \"string\" && domainKeys.includes(prop) ? new UsecaseSelector(prop, requirements[prop]) : Reflect.get(target, prop, receiver);\n      }\n    });\n  }\n};\nclass ActorNotAuthorizedToInteractIn extends Error {\n  constructor(actor, domain, usecase) {\n    super(`The actor \"${actor.constructor.name}\" is not authorized to interact on usecase \"${String(usecase)}\" of domain \"${String(domain)}\".`);\n  }\n}\nconst KeyFactory = class KeyFactory2 {\n  constructor() {\n    return new Proxy(this, {\n      get(target, prop, receiver) {\n        return typeof prop === \"string\" && !(prop in target) ? prop : Reflect.get(target, prop, receiver);\n      }\n    });\n  }\n};\nconst SwiftEnum = class SwiftEnum2 {\n  constructor(f) {\n    this.keys = new KeyFactory();\n    return new Proxy(this, {\n      get(target, prop, receiver) {\n        return typeof prop === \"string\" && !(prop in target) ? (associatedValues) => f !== void 0 ? Object.freeze(Object.assign(new f(), Object.assign(associatedValues || {}, { case: prop }))) : Object.freeze(Object.assign(associatedValues || {}, { case: prop })) : Reflect.get(target, prop, receiver);\n      }\n    });\n  }\n};\nexport { AbstractActor, ActorNotAuthorizedToInteractIn, CourseSelector, InteractResultType, Nobody, Robustive, Scenario, SwiftEnum, UsecaseImple, UsecaseSelector, isNobody };\n//# sourceMappingURL=robustive.es.js.map\n","import {\n    Scenario,\n    UsecaseImple,\n    Context,\n    Scenes,\n    IActor,\n    InferScenes,\n    DomainRequirements,\n    NOCARE,\n    Empty,\n    SwiftEnum,\n    SwiftEnumCases,\n    ActorNotAuthorizedToInteractIn,\n} from \"@robustive/robustive-ts\";\nimport { Request, Response } from \"express\";\n\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\nexport type Self = any;\n\ntype ResponseStatusContext = {\n    normal: { statusCode: number; }\n    responded: Empty\n}\n\nexport const ResponseStatus = new SwiftEnum<ResponseStatusContext>();\nexport type ResponseStatus = SwiftEnumCases<ResponseStatusContext>;\n\nexport type ResponseContext<Z extends Scenes> = Context<Z> & { status?: ResponseStatus };\n\ndeclare module \"@robustive/robustive-ts\" {\n    interface IScenarioDelegate<Z extends Scenes> {\n        proceedUntilResponse?<A extends IActor<NOCARE>, S extends Scenario<Z>>(req: Request, res: Response, to: Context<Z>, actor: A, scenario: S): Promise<ResponseContext<Z>>;\n    }\n\n    interface Scenario<Z extends Scenes> {\n        proceedUntilResponse<A extends IActor<NOCARE>>(req: Request, res: Response, to: Context<Z>, actor: A): Promise<ResponseContext<Z>>;\n        respond(next: Context<Z>, status?: ResponseStatus): Promise<ResponseContext<Z>>;\n    }\n\n    interface UsecaseImple<R extends DomainRequirements, D extends keyof R, U extends keyof R[D]> {\n        handleRequest<User, A extends IActor<User>>(req: Request, res: Response, actor: A, recursiveWrapper?: (recursive: () => Promise<HandleResult<R, D, U, A, InferScenes<R, D, U>>>) => Promise<HandleResult<R, D, U, A, InferScenes<R, D, U>>>): Promise<HandleResult<R, D, U, A, InferScenes<R, D, U>>>;\n    }\n}\n\nScenario.prototype.proceedUntilResponse = function <Z extends Scenes, A extends IActor<NOCARE>>(\n    this: Scenario<Z>,\n    req: Request,\n    res: Response,\n    to: Context<Z>,\n    actor: A\n): Promise<ResponseContext<Z>> {\n    if (this.delegate !== undefined && this.delegate.proceedUntilResponse !== undefined) {\n        return this.delegate.proceedUntilResponse(req, res, to, actor, this);\n    }\n    return Promise.reject(new Error());\n};\n\nScenario.prototype.respond = function <Z extends Scenes>(\n    this: Scenario<Z>,\n    next: Context<Z>,\n    status: ResponseStatus = ResponseStatus.normal({ statusCode: 200 })\n): Promise<ResponseContext<Z>> {\n    return Promise.resolve({ ...next, status });\n};\n\nexport const HandleResultType = {\n    success: \"success\"\n    , failure: \"failure\"\n} as const;\n\ntype HandleResultContext<R extends DomainRequirements, D extends keyof R, U extends keyof R[D], A extends IActor<NOCARE>, Z extends Scenes> = {\n    [HandleResultType.success] : {\n        id: string;\n        actor : A;\n        domain : D;\n        usecase : U;\n        startAt : Date;\n        endAt : Date;\n        elapsedTimeMs : number;\n        performedScenario : ResponseContext<Z>[];\n        lastSceneContext : ResponseContext<Z>;\n    };\n    [HandleResultType.failure] : {\n        id: string;\n        actor : A;\n        domain : D;\n        usecase : U;\n        startAt : Date;\n        endAt : Date;\n        elapsedTimeMs : number;\n        performedScenario : ResponseContext<Z>[];\n        failedSceneContext : ResponseContext<Z>;\n        error: Error;\n    };\n};\n\ntype HandleResultCase<R extends DomainRequirements, D extends keyof R, U extends keyof R[D], A extends IActor<NOCARE>, Z extends Scenes, K extends keyof HandleResultContext<R, D, U, A, Z>> = Record<\"type\", K> & HandleResultContext<R, D, U, A, Z>[K];\n\nexport type HandleResult<R extends DomainRequirements, D extends keyof R, U extends keyof R[D], A extends IActor<NOCARE>, Z extends Scenes> = { \n    [K in keyof HandleResultContext<R, D, U, A, Z>] : HandleResultCase<R, D, U, A, Z, K>;\n}[keyof HandleResultContext<R, D, U, A, Z>];\n\n/**\n * @param recursiveWrapper An optional function to wrap the recursive calls. Useful for integrating with async context tracking.\n */\nUsecaseImple.prototype.handleRequest = function <R extends DomainRequirements, D extends keyof R, U extends keyof R[D], User, A extends IActor<User>, T extends object>(\n    this: UsecaseImple<R, D, U>,\n    req: Request,\n    res: Response,\n    actor: A,\n    recursiveWrapper?: (recursive: () => Promise<HandleResult<R, D, U, A, InferScenes<R, D, U>>>) => Promise<HandleResult<R, D, U, A, InferScenes<R, D, U>>>\n): Promise<HandleResult<R, D, U, A, InferScenes<R, D, U>>> {\n    const self = this as Self;\n    const startAt = new Date();\n    const recursive = (req: Request, res: Response, scenario: ResponseContext<InferScenes<R, D, U>>[]): Promise<ResponseContext<InferScenes<R, D, U>>[]> => {\n        const lastScene = scenario.slice(-1)[0];\n        if (lastScene.course === \"goals\" || lastScene.status) { // exit criteria\n            return Promise.resolve(scenario);\n        }\n\n        return self._scenario.proceedUntilResponse(req, res, lastScene, actor)\n            .then((nextScene: ResponseContext<InferScenes<R, D, U>>) => {\n                self.currentContext = nextScene;\n                scenario.push(nextScene);\n                return recursive(req, res, scenario);\n            });\n    };\n\n    if (self._scenario.authorize && !self._scenario.authorize(actor, self._domain as Extract<D, string>, self._usecase as Extract<U, string>)) {\n        const err = new ActorNotAuthorizedToInteractIn(actor, self._domain, self._usecase);\n        return Promise.reject(err);\n    }\n\n    const scenario: ResponseContext<InferScenes<R, D, U>>[] = [self.currentContext as ResponseContext<InferScenes<R, D, U>>];\n\n    const execRecursion = () => recursive(req, res, scenario)\n        .then((performedScenario) => {\n            const endAt = new Date();\n            const elapsedTimeMs = (endAt.getTime() - startAt.getTime());\n            const lastSceneContext = performedScenario.slice(-1)[0];\n            return {\n                type: HandleResultType.success\n                , id: self.id\n                , actor\n                , domain: self._domain\n                , usecase : self._usecase\n                , startAt\n                , endAt\n                , elapsedTimeMs\n                , performedScenario\n                , lastSceneContext\n            } as HandleResultCase<R, D, U, A, InferScenes<R, D, U>, \"success\">;\n        })\n        .catch((error: Error) => {\n            const endAt = new Date();\n            const elapsedTimeMs = (endAt.getTime() - startAt.getTime());\n            const lastSceneContext = scenario.slice(-1)[0];\n            return {\n                type: HandleResultType.failure\n                , id: self.id\n                , actor\n                , domain: self._domain\n                , usecase : self._usecase\n                , startAt\n                , endAt\n                , elapsedTimeMs\n                , performedScenario : scenario\n                , failedSceneContext : lastSceneContext\n                , error\n            } as HandleResultCase<R, D, U, A, InferScenes<R, D, U>, \"failure\">;\n        });\n\n    if (recursiveWrapper) {\n        return recursiveWrapper(execRecursion);\n    } else {\n        return execRecursion();\n    }\n// eslint-disable-next-line @typescript-eslint/no-explicit-any\n} as any;"],"names":["AbstractActor","user","Nobody","isNobody","actor","SceneFactory","target","prop","receiver","ContextFactory","course","withValues","SceneFactoryAdapter","Scenario","domain","usecase","id","to","next","withResult","InteractResultType","InteractResultFactory","generateId","length","S","n","currentContextStore","UsecaseImple","initialContext","scenario","context","delegate","err","ActorNotAuthorizedToInteractIn","nextScene","startAt","InteractResult","recursive","scenario2","lastScene","performedScenario","endAt","elapsedTimeMs","lastSceneContext","result","error","ScenarioFactory","_id","s","usecaseImple","CourseSelector","UsecaseSelector","scenarioConstructors","usecaseKeys","keys","Robustive","requirements","domainKeys","KeyFactory","SwiftEnum","f","associatedValues","ResponseStatus","req","res","status","HandleResultType","recursiveWrapper","self","execRecursion"],"mappings":"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"}